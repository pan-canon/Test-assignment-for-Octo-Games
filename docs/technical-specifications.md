1) Цель и результат
Собрать рабочий прототип визуальной новеллы для работы внутри браузера, демонстрирующий:
переключение между двумя персонажами-детективами (♂/♀);
переключение экранов по стрелкам расположенным слевой и справой стороны (вперёд/назад);
систему экранов/слайдов с фоном, репликой и опциональными выборами;
шкалу отношений, которая изменяется от игроковых выборов;
нижнюю инфо-панель с пагинацией текста стрелками слева/справа и анимацией сворачивания.

2) Термины и роли
Экран (Screen) — единица сюжета: фон + реплика (+варианты выбора) + опциональный “инфо-текст” в нижней панели. Имеет уникальный id.
Персонаж (Character) — текущая “роль игрока” (male/female). От него зависят фон и реплика, а также набор доступных выборов.
Выбор (Action) — вариант ответа с эффектом на отношения (effect: ±N) и опциональным переходом next на другой экран.
Шкала отношений (Relationship) — целое число, суммируется по сделанным выборам и корректно откатывается при навигации “Назад”.
История (History) — стек состояний для корректного “Назад”.
Порог отношений (relationshipThreshold) — минимальное значение шкалы отношений, при котором экран становится доступен.
Инфо-панель (Info panel) — нижний полноширинный блок с дополнительным текстом и пагинацией, умеет сворачиваться и показывать оверлей.
Кастомный скрипт (Custom script) — внешний модуль, подключаемый экраном по id для расширения UI (иконки действий, оверлеи и т. п.).
Панель действий (Action icons) — контейнер в правом верхнем углу, в который кастомные скрипты монтируют свои кнопки.

3) Геймплей и UX-поток
Сверху по центру — кнопки выбора персонажа (♂/♀). Переключение не должно ломать текущий экран и может блокироваться экраном (см. флаг disableGenderSelection).
В правом верхнем углу зарезервирована зона для иконок действий (action icons). Через неё кастомные скрипты могут добавлять интерактивные элементы (например, “бинокль”). Зона всегда присутствует и не конфликтует с другими элементами.
На фоне — полноэкранное изображение сцены (под текущего персонажа, изменяется через конфиг).
В левом верхнем углу — подпись вида “Scene <title>” (title берётся из конфига). Текст не мешает кликам по нижележащим элементам.
Внизу поверх фона — строка/панель с репликой (уникальный текст под текущего персонажа, изменяется через конфиг). Панель центрирована по горизонтали.
Если у экрана есть выборы — они располагаются столбцом под основной репликой, выровнены по центру контейнера и тянутся на ширину текстового блока. Выбранный пункт подсвечивается. До выбора кнопка “Next” неактивна.
Кнопки “Back/Next” закреплены слева/справа по центру экрана по вертикали.
В левом нижнем углу — индикатор отношений.
Если у экрана задан инфо-текст, внизу появляется полноширинная полу-прозрачная панель (info panel). По умолчанию при каждом входе на экран с info-текстом она открыта: занимает ~30% высоты в нижней части, перекрывает содержимое полупрозрачным оверлеем и содержит пагинацию текста. Сверху панели расположена кнопка-стрелка (вниз при открытой панели, вверх при закрытой). При сворачивании панель уезжает вниз, остаётся видимым край с кнопкой-стрелкой; при раскрытии возвращается на место. Клик по оверлею также сворачивает панель. Если инфо-текст отсутствует — панель не показывается.
“Next” переносит на следующий экран:
если выбран Action с next — переход по id;
иначе — к следующему элементу массива экранов.
“Back” откатывает на предыдущий экран, состояние восстанавливается из истории (включая шкалу отношений). Кнопка неактивна, если предыдущего шага нет.

4) Нефункциональные требования
Среда: нативные ES-модули (без фреймворков), работает в актуальных Chrome/Firefox/Edge (десктоп и планшеты).
Верстка: BEM-именование, фоны тянуты на всю ширину/высоту, элементы управления не перекрываются слоями (заметка: Codex не справился на вёрстке, правил руками).
Адаптивность: контейнер игры на всю высоту вьюпорта; кликабельные области кнопок и стрелок — не менее 40×40px.
Производительность: без заметных перерисовок и “скачков” при пагинации текста; измерение текста — без утечек DOM-узлов.
Доступность: состояния disabled для недоступных кнопок; фокусируемость основных элементов на ваш выбор; разумные aria-атрибуты (минимальный набор).

5) Архитектура (Hexagonal + OOP)
Домен (core)
Game — единая точка состояния и правил навигации. Хранит массив Screen, индекс текущего экрана, текущего персонажа, историю, шкалу отношений и состояние нижней панели. Обязанности:

hasPrevScreen() / hasNextScreen() — доступность переходов;
switchCharacter(char) — смена персонажа (сброс выбора и пересчёт доступности Next, игнорируется если экран запретил выбор пола);
selectAction(action) — применение/перевыбор с корректной компенсацией предыдущего эффекта;
nextScreen() — пушит состояние в историю, учитывает обязательный выбор действия, находит следующий доступный экран (action.next > фильтр по relationshipThreshold, далее линейный перебор) и отключает возможность “Next”, если следующих экранов нет;
prevScreen() — достаёт последнее состояние из истории (и сбрасывает выбранный action);
canSwitchCharacter() / requiresActionSelection() — вспомогательные геттеры для UI.

Screen — DTO + геттеры: фон/текст под персонажа, список действий, инфо-текст, relationshipThreshold, disableGenderSelection, title, customScripts.

TextPaginator — расчёт постраничного деления текста под заданный контейнер (с учётом его реальных размеров) без привязки к DOM.
Адаптеры (adapters)
DomAdapter — связывает Game с DOM: обновляет фон, реплику, выборы, индикаторы, состояния кнопок, action icons, нижнюю панель; вешает обработчики.

InfoBox — UI-надстройка над TextPaginator: рендерит нижнюю панель, управляет пагинацией, состоянием открытия/закрытия, стрелками и оверлеем.

CustomScriptManager — инициализирует/отключает сценарные расширения, регистрируемые по id.

Стили
BEM-блок screen и элементы: screen__image, screen__text, screen__choices, screen__button--next|--back, screen__character, screen__actions, screen__scene-title, screen__relationship, screen__info-panel, screen__info-content, screen__info-arrow--prev|--next, screen__info-toggle и т. д. по вашему усмотрению, главное не идти наперекор методологии.

6) Конфигурация экранов
Файл: src/config/screens.js (или config/screens.js в корне проекта).
Схема одного экрана:
{
  id: 'wrapup', // string, уникальный ID (обязателен)
  title: 'Wrap Up', // string, обязательный заголовок для подписи “Scene <title>”
  relationshipThreshold: 2, // optional, минимальное значение отношений для показа экрана
  disableGenderSelection: true, // optional, блокирует переключение персонажа на время экрана
  images: { // обязательны ключи 'male' и 'female'
    male: 'images/..png',
    female: 'images/..png'
  },
  texts: { // реплики под каждого персонажа (обязательны)
    male: '...',
    female: '...'
  },
  info: '...', // опциональный длинный текст для нижней панели (может быть пустой/отсутствовать)
  actions: { // опционально; если отсутствует — экран “без выборов”
    male: [ // массив вариантов (может отличаться для male/female)
      { text: '...', effect: +1, next: 'case' },
      { text: '...', effect: -1, next: 'wrapup' }
    ],
    female: [
      { text: '...', effect: +1, next: 'case' }
    ]
  },
  customScripts: [ // optional, список подключаемых кастомных скриптов
    {
      id: 'magnifier', // string, ключ зарегистрированного скрипта
      options: { // произвольный набор параметров для скрипта
        image: 'images/zoom.png',
        label: 'Open spyglass view',
        closeLabel: 'Close spyglass view'
      }
    }
  ]
}

Правила/валидация:
id уникален. Все значения action.next должны указывать на существующие id (или быть опущены).

title обязателен для каждого экрана.

relationshipThreshold может быть null/undefined — тогда экран доступен всегда. Если порог указан, экран пропускается до тех пор, пока текущие отношения меньше порога.

disableGenderSelection по умолчанию false. Если true, UI блокирует смену персонажа на время нахождения на экране.

Для каждого экрана — два текста (male/female) и два пути к изображениям (одинаковые допускается).

actions[gender] может отсутствовать или быть пустым массивом — тогда выборов нет, Next доступен сразу (при условии, что есть следующий экран).

effect — целое число, может быть 0 (без влияния).

customScripts — массив объектов. Каждый id должен существовать в реестре (см. раздел про кастомные скрипты). Параметры options валидируются соответствующим скриптом.

В конфиге у экранов в комментариях проставлять номера (для удобства навигации при разработке).

Не хранить логику в конфиге: только данные.

7) Поведение и состояния (детализация)
Кнопка Next:

- активна только при наличии следующего экрана (Game.hasNextScreen() === true);
- если на текущего персонажа есть обязательные выборы — активна только при выбранном пункте;
- при переходе сбрасывает выбранный пункт и переходит к следующему доступному экрану (учитывая relationshipThreshold);
- после достижения последнего доступного экрана остаётся в состоянии disabled и не реагирует на клики.

Кнопка Back:

- активна только при наличии предыдущего состояния в истории;
- по нажатию восстанавливает индекс экрана и значение шкалы отношений, существовавшее на момент входа на этот экран.

Переключение персонажа:

- не меняет relationship;
- запрещено, если текущий экран передал disableGenderSelection = true;
- при разрешённом переключении сбрасывает выбранный action и обновляет доступность Next, но не переоткрывает инфо-панель и не сбрасывает её состояние;
- ререндерит фон, реплику, доступные выборы и состояние кнопок.

Повторный выбор:

- при смене выбранного action на текущем экране предыдущий эффект компенсируется (вычитается), затем применяется новый.

Инфо-панель:

- рендерится, только если задан непустой info;
- по умолчанию открыта при первом входе на экран и при повторном показе экрана из истории, но не раскрывается повторно при смене персонажа или выборе действия;
- имеет отдельный оверлей; клик по нему или по кнопке-стрелке сворачивает панель, оставляя видимым край с кнопкой;
- при закрытии стрелка направлена вверх, при открытии — вниз;
- при одной странице текста стрелки пагинации скрываются;
- при повторном открытии восстанавливает последний просмотренный номер страницы, если он существует в новом расчёте.

8) Верстка и визуальный слой
БЭМ-блок screen дополняется элементами: screen__scene-title, screen__relationship, screen__text, screen__choices, screen__actions, screen__custom-overlay, screen__info-panel, screen__info-toggle и пр.

DOM-структура экранов начинается с контейнера навигации (screen__controls) — это предотвращает перекрытие остальных элементов за счёт последующего позиционирования. Далее размещаются фон, подпись сцены, индикатор отношений, панель с репликой, контейнер с выбором, панель выбора персонажа, контейнер action icons. Нижняя info panel располагается последней в DOM, чтобы поверх неё можно было натянуть полу-прозрачный оверлей.

Фон (screen__image): position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover.

Подпись сцены, индикатор отношений и текстовая панель получают pointer-events:none, чтобы не блокировать клики по кнопкам под ними.

Выборы (screen__choices): display:flex; flex-direction:column; gap:12px; ширина совпадает с шириной текстовой панели; центровка по горизонтали.

Кнопки навигации (screen__button--next|--back): позиционируются абсолютно, растянуты от верха до низа, выровнены по центру вертикали, имеют z-index выше фонового слоя и текстовых панелей.

Зона action icons (screen__actions): позиционируется в правом верхнем углу, поддерживает несколько inline-кнопок.

Info panel (screen__info-panel): position:absolute; left:0; right:0; bottom:0; min-height ~30% экрана; полу-прозрачный фон. При открытии добавляется оверлей (screen__info-overlay) с z-index ниже панели, но выше основного контента. При закрытии панель смещается transform:translateY(100%) так, чтобы оставалась видимой кнопка-стрелка.

Состояния disabled у кнопок/стрелок — визуально различимы. Стрелки пагинации скрываются классом-модификатором при отсутствии доступных страниц.

9) Работа с текстом в инфо-панели
TextPaginator работает без обращения к реальному DOM: принимает измерения контейнера, возвращает массив страниц (каждая — набор строк/слов). InfoBox отвечает за создание невидимых измерительных элементов и очищает их после вычисления.

Пагинация осуществляется по словам с учётом пробелов и переносов. При первом показе экрана страницы вычисляются один раз и кешируются в Game, чтобы при повторном открытии панели не происходил пересчёт.

При изменении размеров окна (ресайз/ориентация) InfoBox запрашивает у Game исходный текст и пересчитывает страницы заново, стараясь сохранить текущий номер страницы (или выбирая ближайшую допустимую, если количество страниц сократилось).

Если текст помещается в пределах одной страницы, элементы управления пагинацией не отображаются.

10) История и контроль переходов
Перед любым “Next” текущее состояние (индекс экрана + значение отношений + состояние инфо-панели) пушится в стек истории.

Если action.next задан — приоритет у перехода по id. При вычислении следующего экрана Game пропускает все экраны, чьи relationshipThreshold превышают текущие отношения. Если после фильтрации экранов не остаётся, Next переходит в состояние disabled.

Если action.next ведёт в несуществующий id — прототип должен без падения перейти к следующему доступному экрану линейно и залогировать предупреждение (консоль).

При возврате по “Back” восстанавливается состояние шкалы отношений, выбранное действие, а также состояние инфо-панели (открыта/закрыта, текущая страница).

Кастомные скрипты навешиваются при входе на экран и снимаются при выходе (Next/Back, смена экрана по action.next). Скрипт обязан освободить добавленные DOM-узлы/слушатели. Реестр скриптов не должен содержать дубликаты id.

Зацикливание сценария не предотвращается автоматически — ответственность сценариста (см. “Риски”).

11) Структура проекта (рекомендованная)
/index.html
/styles/
  main.css
/scripts/
  app.js
/core/
  Game.js
  Screen.js
  Character.js
  TextPaginator.js
/adapters/
  domAdapter.js
  InfoBox.js
/customScripts/
  CustomScriptManager.js
  registry.js
  /scripts/
    MagnifierScript.js
/config/
  screens.js
/images/
  ... (заглушки)

12) Тестирование и приёмка
Unit/logic:
Game.hasPrevScreen()/hasNextScreen() — корректные true/false на краях и при фильтрации по relationshipThreshold;
Game.selectAction() — компенсация эффекта при перевыборе;
Game.nextScreen() — запись в историю, сброс selectedAction, ветвление по next и пропуск недоступных экранов;
Game.prevScreen() — восстановление индекса, relationship и состояния инфо-панели;
Game.canSwitchCharacter() — учитывает флаг disableGenderSelection;
Screen.isAvailableForRelationship() — корректно обрабатывает null/числовые значения;
TextPaginator.paginate() — корректная разбивка и отсутствие “утекших” узлов;
InfoBox — корректные состояния стрелок при 1/2/N страницах, восстановление страницы после ресайза;
CustomScriptManager — инициализация/деинициализация по смене экрана, отсутствие протечек обработчиков.

UI/behavior (ручные сценарии):
Линейный экран без выборов — Next активен, фон на весь экран, после последнего экрана Next дизейблится.
Экран с выбором — Next неактивен до клика, выбранный пункт подсвечивается, повторный выбор корректно меняет очки.
RelationshipThreshold — при недостатке очков экран пропускается, логируется предупреждение только при реальном отсутствии id.
Back/Next — корректно активируются/деактивируются по краям, шкала отношений и инфо-панель откатываются.
Инфо-панель — появляется только при наличии текста; по умолчанию открыта, сворачивается по стрелке и по клику на оверлей; стрелка меняет направление; после сворачивания остаётся видимой кнопка-стрелка.
Переключение персонажа — фон/текст/варианты меняются; выбранный пункт сбрасывается; инфо-панель остаётся в прежнем состоянии; Next и реплика соответствуют новому персонажу; при disableGenderSelection переключение заблокировано визуально и логически.
Action icons — в правом верхнем углу отображается иконка скрипта (бинокль), открывает/закрывает кастомный оверлей с изображением и корректно очищается при смене экрана.
Ветвление — переход по action.next работает, при отсутствии next — линейный переход.
Адаптив — интерфейс кликабелен на ширине 768–1366px (и выше), фиксация навигации по центру по вертикали.

Материалы для примера/демо: минимум 4 экрана (start, intro, case, wrapup) — с разной комбинацией выборов и инфо-панели.
Критерий приёмки: все сценарии выше выполняются без ошибок в консоли, визуальный слой соответствует описанию, UX-ограничения соблюдены.

13) Риски и меры
Выбор остался при смене персонажа → при switchCharacter обязательно сбрасывать selectedAction.
Двойное применение эффекта → при выборе нового варианта сначала компенсировать эффект старого.
Перекрытие кнопок слоями → соблюдать порядок DOM и pointer-events:none у статичных блоков, инфо-панель держать поверх с оверлеем, навигацию — над контентом.
Инфо-панель повторно открывается после любого события → фиксировать состояние в Game и переиспользовать между выбором/сменой персонажа.
Инфо-панель перекрывает контент в закрытом состоянии → оставлять видимым край с кнопкой, корректировать transform.
Некорректная пагинация текста при изменении размеров → добавлять обработчик resize с переподсчётом; очищать временные узлы.
Стрелки пагинации отображаются при одной странице → скрывать их через класс-модификатор.
Отсутствует next или несуществующий id → логировать предупреждение и идти линейно к следующему экрану.
RelationshipThreshold не совпадает с дизайном → документировать ожидаемые значения и проверять сценарии руками.
Пустые/битые изображения → в DomAdapter добавить onerror-обработчик с подстановкой заглушки.
Кастомный скрипт не отчистил DOM → в CustomScriptManager требовать метод dispose и вызывать при любом выходе с экрана.
Зацикливание сценария → фиксировать в ревью конфигурации (правило: карты переходов при коммите).
Регресс отношений при навигации → хранить relationship в истории до применения следующего экрана.
Клики по “Next” без выбора → всегда проверять условие доступности перед переходом.
Прыжки верстки из-за шрифтов → использовать предзагрузку шрифтов/системные шрифты в прототипе.
Слишком длинные реплики в нижней панели → однострочное/двухстрочное ограничение + многоточие, полный текст — через инфо-панель.

14) Документация (README — минимум)
Краткое описание проекта и требований к окружению.
Раздел “Конфигурация”: поля экрана, правила, пример “шаблона экрана”.
Инструкция запуска (статический сервер) и как добавить новый экран/изображение.
Тесты: как запустить.

15) Бэклог (не в рамках минимального прототипа)
Сохранение/загрузка прогресса (localStorage or||and indexDB).
i18n конфиг (ключи + JSON-локали).
Экран-скрипты (хуки) для мини-логики.
Прелоадер ассетов и фоновой подгрузки следующих экранов.
Озвучка/музыка, эффекты появления панелей.
Клавиатурное управление (←/→, Enter, Esc).

16) Пример набора файлов (референс)
index.html — контейнер игры, иконки персонажей, блоки screen__*.
styles/main.css — BEM, фон object-fit: cover, фиксация стрелок по центру, слои и disabled-состояния.
core/ — Game, Screen, Character, TextPaginator.
adapters/ — DomAdapter (биндинги и рендер), InfoBox (нижняя панель, пагинация и оверлей).
config/screens.js — массив экранов (минимум 4), с комментариями-номерами и примерами next.

17) Принципы качества
Простая, читаемая архитектура и единые названия (BEM/классы/ключи).
Чёткая изоляция домена от DOM-реализации.
Конфиг-первый подход: сценаристы меняют данные без правок кода.
Предсказуемые состояния UI (включая disabled).
Минимум “магии” и побочных эффектов — всё явно.

Кратко: что именно сдаём
Репозиторий с описанной структурой и исходниками.
Демонстрационный сценарий на 4 экрана (с ветвлением и инфо-панелью).
README с описанием конфига и инструкцией запуска.
Базовые тесты логики.
Визуально: фуллскрин фон, центральные стрелки, нижняя реплика, выборы по центру, необязательная инфо-панель снизу с пагинацией, счётчик отношений слева внизу, кнопки по бокам по центру.
